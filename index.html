<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
	<title>Barcode Sertifikasi SNI</title>
	<style>
		.section-preview{
			width: 100%;
			height: 841.89px;
			display: none;
		}
		.section-preview iframe{
			width: 100%;
			height: 100%;
		}
	</style>
</head>

<body class="bg-light">
	<nav class="navbar navbar-dark bg-primary shadow-md">
		<div class="container">
			<a class="navbar-brand" href="#">Barcode Sertifikasi SNI</a>
		</div>
	</nav>
	<div class="container pt-3">
		<div class="shadow rounded px-5 py-4 bg-white">
			<h3 class="h3">Barcode Sertifikat</h3>
			<hr>
			<div class="form-group row">
				<label for="inputNomorSertifikat" class="col-sm-2 col-form-label">Nomor Sertifikat</label>
				<div class="col-sm-10">
					<input type="text" class="form-control" id="inputNomorSertifikat">
				</div>
			</div>
			<div class="form-group row">
				<label for="selectJenisSertifikat" class="col-sm-2 col-form-label">Jenis Sertifikat</label>
				<div class="col-sm-10">
					<select class="form-control" id="selectJenisSertifikat">
						<option value="">Pilih Jenis</option>
						<option value="1">SPPT SNI</option>
						<option value="2">Sertifikat Kesesuaian SNI wajib</option>
						<option value="3">Sertifikat Kesesuaian SNI Sukarela</option>
					</select>
				</div>
			</div>
			<div class="form-group row">
				<label for="uploadSertifikat" class="col-sm-2 col-form-label">Upload Sertifikat</label>
				<div class="col-sm-10">
					<input type="file" class="form-control" accept=".pdf" id="uploadSertifikat">
					<small class="text-danger">*File Format PDF</small>
				</div>
			</div>
			<button type="button" class="btn btn-primary" id="btnSubmit">Submit!</button>
			<hr>
			<div class="center">
				<div id="qrcodeRender"></div>
			</div>
		</div>
	</div>
	<div class="container mt-3 ">
		<div class="row">
			<div class="col-md-6">
				<div class="section-preview shadow-md mx-auto rounded" id="container-preview">
					<button type="button" class="btn btn-primary" id="btnPrintPDF">Print</button>
					<iframe src="" frameborder="0" id="preview"></iframe>
				</div>
			</div>
			<div class="col-md-6">
				<div class="section-preview shadow-md mx-auto rounded" id="container-previewPDFKosong">
					<button type="button" class="btn btn-primary" id="btnPrintPDFKosong">Print</button>
					<iframe src="" frameborder="0" id="previewPDFKosong"></iframe>
				</div>
			</div>
		</div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js" integrity="sha512-z8IYLHO8bTgFqj+yrPyIJnzBDf7DDhWwiEsk4sY+Oe6J2M+WQequeGS7qioI5vT6rXgVRb4K1UVQC5ER7MKzKQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script type="text/javascript">
	$(function() {
		let base64QR = "";
		$("body").on("click", "#btnSubmit", function() {
			let nomor_sertif = $("#inputNomorSertifikat").val();
			$("#qrcodeRender").html("");
			let qrcode = new QRCode(document.getElementById("qrcodeRender"), {
				text: nomor_sertif,
				width: 128,
				height: 128,
				colorDark: "#000000",
				colorLight: "#ffffff",
				correctLevel: QRCode.CorrectLevel.H
			});

			setTimeout(function() {
				// ambil QR sebagai PNG
				const imgSrc = $("#qrcodeRender img").attr("src");
				const base64 = imgSrc.split(",")[1];
				const pngBytes = base64ToUint8Array(base64);
				generatePDF(pngBytes);
				generatePDFKosong(pngBytes);
			}, 500);
		})

		function base64ToUint8Array(base64) {
			const raw = atob(base64);
			const u8 = new Uint8Array(raw.length);
			for (let i = 0; i < raw.length; i++) u8[i] = raw.charCodeAt(i);
			return u8;
		}
		async function generatePDF(pngBytes) {
			const fileInput = document.getElementById("uploadSertifikat");
			if (!fileInput.files.length) {
				alert("Pilih file PDF dulu!");
				return;
			}

			const file = fileInput.files[0];
			const originalBytes = await file.arrayBuffer();

			// load PDF
			const pdfDoc = await PDFLib.PDFDocument.load(originalBytes);
			const pngImage = await pdfDoc.embedPng(pngBytes);

			// halaman pertama
			const page = pdfDoc.getPage(0);

			// tempel QR ke posisi tertentu
			let positionQr = [];
			let jenisSertifikat = $("#selectJenisSertifikat").val();
			switch (jenisSertifikat) {
				case "1": //SPPT SNI
					positionQr = {
						x: 50,
						y: 200,
						width: 75,
						height: 75
					};
					break;
				case "2": // Sertifikat Kesesuaian SNI wajib
					positionQr = {
						x: 50,
						y: 150,
						width: 75,
						height: 75
					};
					break;
				case "3": // Sertifikat Kesesuaian SNI Sukarela
					positionQr = {
						x: 50,
						y: 150,
						width: 75,
						height: 75
					};
					break;
			}
			page.drawImage(pngImage, positionQr);

			// hasil PDF final
			const newPdfBytes = await pdfDoc.save();

			// buat blob untuk preview
			const blob = new Blob([newPdfBytes], { type: "application/pdf" });
			const url = URL.createObjectURL(blob);

			// tampilkan di iframe preview
			$('#preview').attr('src', url);
			$('#container-preview').show();
		}
		async function generatePDFKosong(pngBytes) {

			// load PDF
			const pdfDoc = await PDFLib.PDFDocument.create();
			const pngImage = await pdfDoc.embedPng(pngBytes);

			// halaman pertama
			const page = pdfDoc.addPage([595.28, 841.89]);

			// tempel QR ke posisi tertentu
			let positionQr = [];
			let jenisSertifikat = $("#selectJenisSertifikat").val();
			switch (jenisSertifikat) {
				case "1": //SPPT SNI
					positionQr = {
						x: 50,
						y: 200,
						width: 75,
						height: 75
					};
					break;
				case "2": // Sertifikat Kesesuaian SNI wajib
					positionQr = {
						x: 50,
						y: 150,
						width: 75,
						height: 75
					};
					break;
				case "3": // Sertifikat Kesesuaian SNI Sukarela
					positionQr = {
						x: 50,
						y: 150,
						width: 75,
						height: 75
					};
					break;
			}
			page.drawImage(pngImage, positionQr);

			// hasil PDF final
			const newPdfBytes = await pdfDoc.save();

			// buat blob untuk preview
			const blob = new Blob([newPdfBytes], { type: "application/pdf" });
			const url = URL.createObjectURL(blob);

			// tampilkan di iframe preview
			$('#previewPDFKosong').attr('src', url);
			$('#container-previewPDFKosong').show();

		}
		$("body").on("click", "#btnPrintPDF", function() {
			const iframe = document.getElementById("preview");
			// iframe.onload = function() {
				iframe.contentWindow.focus();
				iframe.contentWindow.print();
			// };
		});

		$("body").on("click", "#btnPrintPDFKosong", function() {
			const iframe = document.getElementById("previewPDFKosong");
			// iframe.onload = function() {
				iframe.contentWindow.focus();
				iframe.contentWindow.print();
			// };
		});
	})
	</script>
</body>

</html>